<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Video Player with Search</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<link rel="stylesheet" href="style.css" />
		<script src="https://unpkg.com/lucide-react@latest/umd/lucide-react.min.js"></script>
	</head>
	<body class="bg-gray-100">
		<div class="container mx-auto py-8">
			<div class="mb-2 text-center">
				<h2 id="video-title" class="text-xl font-semibold text-gray-800"></h2>
			</div>
			<div class="mb-4">
				<video
					id="video-player"
					class="w-full md:w-1/2 aspect-video rounded-lg mx-auto"
					controls
				></video>
			</div>

			<div class="mb-4 flex justify-center space-x-4">
				<button
					id="prev-video"
					class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300"
				>
					Previous
				</button>
				<button
					id="skip-back"
					class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300"
				>
					<< 10s
				</button>
				<button
					id="play-pause"
					class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400"
				>
					Play
				</button>
				<button
					id="skip-forward"
					class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300"
				>
					10s >>
				</button>
				<button
					id="next-video"
					class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300"
				>
					Next
				</button>
			</div>

			<div class="mb-6">
				<div class="relative">
					<input
						type="text"
						id="search-input"
						class="w-full px-4 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
						placeholder="Search for songs..."
					/>
					<button
						id="search-button"
						class="absolute right-2 top-1/2 transform -translate-y-1/2 px-4 py-2 bg-indigo-500 text-white rounded-md hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-400"
					>
						Search
					</button>
				</div>
			</div>

			<div class="flex justify-center mb-4">
				<button
					id="find-duplicates"
					class="px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-400"
				>
					Find Duplicate Songs
				</button>
			</div>

			<div class="bg-white rounded-lg shadow-md p-4 max-h-96 overflow-y-auto">
				<ul id="search-results" class="divide-y divide-gray-200"></ul>
			</div>
		</div>

		<script>
			const videoPlayer = document.getElementById('video-player');
			const searchInput = document.getElementById('search-input');
			const searchButton = document.getElementById('search-button');
			const searchResults = document.getElementById('search-results');
			const findDuplicatesButton = document.getElementById('find-duplicates');
			const videoBaseURL = '/videos/';
			const videoTitleElement = document.getElementById('video-title');

			// Get the new control elements
			const prevButton = document.getElementById('prev-video');
			const skipBackButton = document.getElementById('skip-back');
			const playPauseButton = document.getElementById('play-pause');
			const skipForwardButton = document.getElementById('skip-forward');
			const nextButton = document.getElementById('next-video');

			let currentVideoIndex = 0;
			let videoList = [];

			async function searchVideos(query) {
				try {
					const response = await fetch(`/api/songs/search?query=${query}`);
					const results = await response.json();
					videoList = results;
					currentVideoIndex = 0;

					displayResults(results);
				} catch (error) {
					console.error('Error searching videos:', error);
					const li = document.createElement('li');
					li.className = 'py-2 text-red-500 rounded-md px-2';
					li.textContent = 'Error searching videos';
					searchResults.innerHTML = '';
					searchResults.appendChild(li);
				}
			}

			async function findDuplicates() {
				console.log('Finding duplicates...');
				try {
					const response = await fetch('/api/songs/duplicates');
					const results = await response.json();
					console.log('Duplicate results:', results);
					videoList = results;
					currentVideoIndex = 0;

					displayResults(results, 'duplicates');
				} catch (error) {
					console.error('Error finding duplicate videos:', error);
					const li = document.createElement('li');
					li.className = 'py-2 text-red-500 rounded-md px-2';
					li.textContent = 'Error finding duplicate videos';
					searchResults.innerHTML = '';
					searchResults.appendChild(li);
				}
			}

			function displayResults(results, type = 'search') {
				console.log('Displaying results', results);
				searchResults.innerHTML = '';
				if (results && results.length > 0) {
					if (type === 'duplicates') {
						const headerLi = document.createElement('li');
						headerLi.className = 'py-2 bg-yellow-100 rounded-md px-2 mb-2 font-semibold';
						headerLi.textContent = `Found ${results.length} potential duplicate songs`;
						searchResults.appendChild(headerLi);
					}

					results.forEach((result, index) => {
						const li = document.createElement('li');
						li.className =
							'py-2 cursor-pointer hover:bg-gray-100 rounded-md px-2 flex items-center justify-between';
						li.textContent = `${result.Artist} - ${result.Title}`;

						// Create delete button
						const deleteButton = document.createElement('button');
						deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-circle text-red-500 hover:text-red-700 transition-colors duration-200"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>`;
						deleteButton.className = 'ml-4';

						deleteButton.addEventListener('click', (event) => {
							event.stopPropagation();
							showConfirmation(result.songid, result.path, () => {
								deleteVideo(result.songid, result.path, index);
							});
						});

						// Append the delete button to the list item
						li.appendChild(deleteButton);

						li.addEventListener('click', () => {
							currentVideoIndex = index;
							playVideo(currentVideoIndex);
						});
						searchResults.appendChild(li);
					});
					playVideo(0);
				} else {
					const li = document.createElement('li');
					li.className = 'py-2 text-gray-500 rounded-md px-2';
					li.textContent = type === 'duplicates' ? 'No duplicate songs found' : 'No results found';
					searchResults.appendChild(li);
					videoPlayer.src = '';
					playPauseButton.textContent = 'Play';
					videoTitleElement.textContent = '';
				}
			}

			function playVideo(index) {
				if (!videoList || videoList.length === 0) return;

				if (index < 0) {
					index = 0;
				}
				if (index >= videoList.length) {
					index = videoList.length - 1;
				}
				currentVideoIndex = index;

				const videoPath = videoList[index].path;
				const karaokeIndex = videoPath.indexOf('_Karaoke');
				let cleanedPath = videoPath;
				if (karaokeIndex !== -1) {
					cleanedPath = videoPath.substring(karaokeIndex + '_Karaoke'.length + 1);
				}
				const videoUrl = videoBaseURL + cleanedPath;
				console.log('Playing video:', videoUrl);
				videoPlayer.src = videoUrl;
				videoPlayer.play();
				playPauseButton.textContent = 'Pause';
				videoTitleElement.textContent = `${videoList[index].Artist} - ${videoList[index].Title}`;
			}

			function togglePlayPause() {
				if (videoPlayer.paused) {
					videoPlayer.play();
					playPauseButton.textContent = 'Pause';
				} else {
					videoPlayer.pause();
					playPauseButton.textContent = 'Play';
				}
			}

			function skipBack() {
				videoPlayer.currentTime -= 10;
			}

			function skipForward() {
				videoPlayer.currentTime += 10;
			}

			function playNextVideo() {
				currentVideoIndex++;
				if (currentVideoIndex >= videoList.length) {
					currentVideoIndex = 0;
				}
				playVideo(currentVideoIndex);
			}

			function playPreviousVideo() {
				currentVideoIndex--;
				if (currentVideoIndex < 0) {
					currentVideoIndex = videoList.length - 1;
				}
				playVideo(currentVideoIndex);
			}

			searchButton.addEventListener('click', () => {
				const query = searchInput.value.trim();
				if (query) {
					searchVideos(query);
				}
			});

			searchInput.addEventListener('keypress', (event) => {
				if (event.key === 'Enter') {
					searchButton.click();
				}
			});

			findDuplicatesButton.addEventListener('click', findDuplicates);

			// Event listeners for the new control buttons
			playPauseButton.addEventListener('click', togglePlayPause);
			skipBackButton.addEventListener('click', skipBack);
			skipForwardButton.addEventListener('click', skipForward);
			nextButton.addEventListener('click', playNextVideo);
			prevButton.addEventListener('click', playPreviousVideo);

			// Keyboard event listeners for left and right arrows
			document.addEventListener('keydown', (event) => {
				if (event.key === 'ArrowLeft') {
					skipBack();
				} else if (event.key === 'ArrowRight') {
					skipForward();
				}
			});

			//video player events
			videoPlayer.addEventListener('ended', () => {
				playNextVideo();
			});

			function showConfirmation(songid, filePath, callback) {
				const confirmation = confirm('Are you sure you want to delete this video?');
				if (confirmation) {
					callback(songid, filePath);
				}
			}

			async function deleteVideo(songid, filePath, index) {
				try {
					// Delete from the database
					const dbResponse = await fetch(`/api/songs/${songid}`, {
						method: 'DELETE',
					});
					if (!dbResponse.ok) {
						throw new Error('Failed to delete from database');
					}

					const dbResult = await dbResponse.json();
					console.log('Deleted from database:', dbResult);

					// Remove the item from the search results list
					videoList.splice(index, 1); // Remove from videoList
					searchResults.removeChild(searchResults.children[index]); // Remove from the DOM

					// If it was the currently playing video, stop the player and clear the title
					if (currentVideoIndex === index) {
						videoPlayer.src = '';
						playPauseButton.textContent = 'Play';
						videoTitleElement.textContent = '';
					}
					// Adjust currentVideoIndex if necessary
					if (currentVideoIndex > index) {
						currentVideoIndex--;
					}

					if (videoList.length === 0) {
						searchResults.innerHTML = '';
						videoPlayer.src = '';
						playPauseButton.textContent = 'Play';
						videoTitleElement.textContent = '';
					}
				} catch (error) {
					console.error('Error deleting video:', error);
					alert('Failed to delete video. Please check the console for details.');
				}
			}
		</script>
	</body>
</html>
