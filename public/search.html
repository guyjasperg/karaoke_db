<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Songs</title>
    <link href="./styles.css" rel="stylesheet">
    <script type="module" src="../js/main.js"></script>
    <script>
        // Function to search songs
        const searchSongs = async () => {


            const query = document.getElementById('searchQuery').value;
            const field = document.getElementById('searchField').value;
            if (!query) {
                window.modal.open('Song Search', 'Please enter a search term.','error');
                return;
            }

            const trieresult = document.getElementById('trieresult');
            const triesearchresult = window.trie.combinedSearch(query);
            trieresult.innerHTML = '';
            triesearchresult.forEach(element => {
                const highlightedtext = highlightMatch(element, query);
                const li = document.createElement('li');
                // li.textContent = element;
                li.innerHTML = highlightedtext;
                trieresult.appendChild(li);
            });

            const response = await fetch(`/api/songs/search?query=${encodeURIComponent(query)}&field=${encodeURIComponent(field)}`);
            const songs = await response.json();
            const tbody = document.querySelector('#searchResults');
            const resultCount = document.querySelector('#resultCount');
            if (songs.length === 0) {
                window.modal.open('No songs found!', 'Please try a different search term.\nOr request for song to be downloaded :)', 'warning');
                return;
            }
            tbody.innerHTML = songs.map(song => `
                <tr class="hover:bg-gray-100 odd:bg-gray-50 even:bg-white transition duration-200 border-b border-gray-100">
                    <td class="p-3 text-gray-700">
                        <a href="#" onclick="document.getElementById('searchField').value='Artist'; document.getElementById('searchQuery').value='${song.Artist}'; searchSongs(); return false;" class="text-blue-500 hover:text-blue-700 hover:underline">${song.Artist}</a>
                    </td>
                    <td class="p-3 text-gray-700">${song.Title}</td>
                    <td class="p-3 text-gray-700">${new Date(song.Duration).toISOString().substr(14, 5)}</td>
                </tr>
            `).join('');
            resultCount.textContent = `${songs.length} song(s) found.`;
        };

        function highlightMatch(text, match) {
            if (!match) return text; // Handle empty match

            const regex = new RegExp(match, 'gi'); // Case-insensitive, global match
            return text.replace(regex, '<span class="highlight">$&</span>');
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-8">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-4 sm:mb-0">üîç Search Songs</h1>
            <a href="/index.html" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-200">
                üéµ Back to Song Management
            </a>
        </div>

        <!-- Search Form -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Search Songs</h2>
            <div class="flex flex-col sm:flex-row gap-4">
                <select id="searchField" class="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="ALL">ALL</option>
                    <option value="Artist">Artist</option>
                    <option value="Title">Title</option>
                </select>
                <input type="text" id="searchQuery" placeholder="Search by Title, Genre, or Cast" class="flex-1 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" onfocus="this.select()" onkeydown="if(event.key === 'Escape') this.value = ''; if(event.key === 'Enter') document.querySelector('button[onclick=\'searchSongs()\']').click();">
                <button onclick="searchSongs()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-200">
                    üîç Search
                </button>
            </div>
        </div>

        <!-- Search Results Table -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div id="resultCount" class="p-2 text-gray-500 text-right">[Result Count]</div>
            <div class="p-2 text-gray-500">Result from Trie
                <ul id="trieresult"></ul>
            </div>
            <table class="w-full">
                <thead class="bg-gray-200">
                    <tr>
                        <th class="p-3 text-left text-gray-700">Artist</th>
                        <th class="p-3 text-left text-gray-700">Title</th>
                        <th class="p-3 text-left text-gray-700">Duration</th>
                    </tr>
                </thead>
                <tbody id="searchResults">
                    <!-- Search results will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>
</body>
<script type="module" src="app.js" defer></script>
</html>