<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="icon" type="image/svg+xml" href="/public/karaoke-sing-svgrepo-com.svg" />
		<title>Queue</title>
		<link href="./styles.css" rel="stylesheet" />
		<script src="/socket.io/socket.io.js"></script>
		<style>
			.animate-pulse {
				animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
			}
			@keyframes pulse {
				0%,
				100% {
					opacity: 1;
				}
				50% {
					opacity: 0.5;
				}
			}
			.message {
				transition: opacity 0.5s ease-in-out;
			}
			.hidden {
				display: none;
			}
			/* Custom scrollbar for dark theme */
			::-webkit-scrollbar {
				width: 8px;
				height: 8px;
			}
			::-webkit-scrollbar-track {
				background: #1f2937;
			}
			::-webkit-scrollbar-thumb {
				background: #4c1d95;
				border-radius: 4px;
			}
			::-webkit-scrollbar-thumb:hover {
				background: #5b21b6;
			}
			/* Ensure text visibility, override conflicting CSS */
			@media (min-width: 640px) {
				.add-to-queue-btn .text-full {
					display: inline !important;
				}
				.add-to-queue-btn .text-short {
					display: none !important;
				}
			}
			@media (max-width: 639px) {
				.add-to-queue-btn .text-full {
					display: none !important;
				}
				.add-to-queue-btn .text-short {
					display: inline !important;
				}
			}
			/* Ensure search input and results heading stay visible */
			.search-input-container {
				position: sticky;
				top: 0;
				z-index: 10;
				background: #111827; /* bg-gray-900 */
			}
			.results-heading-container {
				position: sticky;
				top: 0;
				z-index: 9;
				background: #1f2937; /* bg-gray-800 */
			}
			/* Scrollable results container */
			.results-scroll-container {
				overflow-y: auto;
			}
			/* Disabled button style */
			.disabled-btn {
				opacity: 0.5;
				cursor: not-allowed;
				pointer-events: none;
			}
			/* Animation for song card when added to queue */
			.animate-song-added {
				animation: song-added 1s ease-in-out;
			}
			@keyframes song-added {
				0% {
					border-color: #10b981;
					box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
				}
				50% {
					border-color: #34d399;
					box-shadow: 0 0 12px rgba(52, 211, 153, 0.7);
				}
				100% {
					border-color: #4b5563;
					box-shadow: none;
				}
			}
			/* Toast message as overlay */
			#message-container {
				position: fixed;
				top: 16px;
				left: 50%;
				transform: translateX(-50%);
				z-index: 20;
				max-width: 90%;
				width: 320px;
				box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
			}
			/* Slide-in animation for toast */
			.animate-slide-in {
				animation: slide-in 0.5s ease-out;
			}
			@keyframes slide-in {
				0% {
					opacity: 0;
					transform: translateY(-20px) translateX(-50%);
				}
				100% {
					opacity: 1;
					transform: translateY(0) translateX(-50%);
				}
			}
			/* Queued badge */
			.queued-badge {
				display: inline-block;
				background-color: #8a60ac; /* green-700 */
				color: #ffffff;
				font-size: 0.75rem; /* text-xs */
				padding: 0.25rem 0.5rem; /* px-2 py-1 */
				border-radius: 0.375rem; /* rounded */
				margin-top: 0.25rem; /* mt-1 */
			}
			/* Custom smaller font for Catalog queued badge */
			.catalog-queued-badge {
				font-size: 0.625rem; /* text-2xs, ~10px */
			}
			/* Focus style for song cards */
			.song-card:focus,
			.catalog-song-card:focus {
				outline: none;
				background-color: #374151; /* bg-gray-700 */
				box-shadow: 0 0 0 2px #3b82f6; /* ring-2 ring-blue-500 */
			}
			/* Spinner styles */
			.animate-spin {
				animation: spin 1s linear infinite;
			}
			@keyframes spin {
				0% {
					transform: rotate(0deg);
				}
				100% {
					transform: rotate(360deg);
				}
			}
			.add-to-queue-btn .spinner {
				display: none;
			}
			.add-to-queue-btn.loading .spinner {
				display: inline-block;
			}
			.add-to-queue-btn.loading .text-full,
			.add-to-queue-btn.loading .text-short {
				display: none;
			}
			/* Alphabet filter buttons */
			.alpha-filter-btn {
				width: 2rem;
				height: 2rem;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 0.75rem; /* text-xs */
				border-radius: 0.375rem; /* rounded */
				margin: 0.125rem; /* m-0.5 */
			}
			.alpha-filter-btn.active {
				background-color: #2563eb; /* bg-blue-600 */
			}
			/* Sticky alphabet filter container */
			.alpha-filter-container {
				position: sticky;
				top: 0;
				z-index: 9;
				background: #1f2937; /* bg-gray-800 */
				padding: 0.5rem 0; /* py-2 */
			}
			/* Artist group header */
			.artist-group-header {
				cursor: pointer;
				transition: background-color 0.2s;
				display: flex;
				justify-content: center;
				align-items: center;
			}
			.artist-group-header:hover {
				background-color: #374151; /* bg-gray-700 */
			}
			/* Catalog song card styles */
			.catalog-song-card {
				padding-left: 1rem; /* pl-4 for indentation */
			}
			.catalog-song-card .song-title {
				font-size: 1.125rem; /* text-lg */
			}
			.catalog-song-card .song-details {
				font-size: 0.875rem; /* text-sm */
			}
			/* Playback controls */
			.playback-controls {
				display: flex;
				gap: 1rem; /* space-x-4 */
				justify-content: center;
				padding: 1rem 0; /* py-4 */
				position: fixed;
				bottom: 0;
				left: 0;
				right: 0;
				background: #1f2937; /* bg-gray-800 */
				z-index: 20;
				box-sizing: border-box;
			}
			/* Ensure queue content isn't hidden under fixed controls */
			#queue-results {
				padding-bottom: 4rem; /* Matches playback-controls height */
			}
			/* Responsive playback button styles */
			.playback-controls button {
				display: flex;
				align-items: center;
				justify-content: center;
			}
			@media (max-width: 639px) {
				.playback-controls button {
					width: 2.5rem; /* Smaller buttons on mobile */
					height: 2.5rem;
					padding: 0;
				}
				.playback-controls .btn-text {
					display: none;
				}
				.playback-controls .btn-icon {
					display: block;
				}
			}
			@media (min-width: 640px) {
				.playback-controls .btn-text {
					display: block;
				}
				.playback-controls .btn-icon {
					display: none;
				}
			}
			/* Responsive search and queue list compression */
			@media (max-width: 639px) {
				#search-results .song-card,
				#queue-results .song-card {
					padding-top: 0.25rem; /* Reduced from 0.5rem */
					padding-bottom: 0.25rem;
					margin-bottom: 0.125rem; /* Reduced from 0.25rem */
				}
				#search-results .space-y-2,
				#queue-results .space-y-2 {
					--tw-space-y-reverse: 0;
					margin-top: calc(0.125rem * calc(1 - var(--tw-space-y-reverse)));
					margin-bottom: calc(0.125rem * var(--tw-space-y-reverse));
				}
			}
			/* Playback controls overlay */
			.playback-overlay {
				position: fixed;
				top: auto;
				bottom: 0;
				left: 0;
				right: 0;
				height: 4rem; /* Matches playback-controls height with padding */
				background: rgba(17, 24, 39, 0.7); /* bg-gray-900/70 */
				display: flex;
				align-items: center;
				justify-content: center;
				z-index: 21;
				cursor: pointer;
			}
			.playback-overlay.hidden {
				display: none;
			}
			.playback-overlay svg {
				pointer-events: none;
			}
			/* Modal styles */
			#pin-modal {
				position: fixed;
				inset: 0;
				display: flex;
				align-items: center;
				justify-content: center;
				z-index: 30;
				visibility: hidden;
			}
			#pin-modal.show {
				visibility: visible;
			}
			#pin-modal .modal-backdrop {
				position: absolute;
				inset: 0;
				background: rgba(0, 0, 0, 0.5); /* Semi-transparent black */
			}
			#pin-modal .modal-content {
				background: #1f2937; /* bg-gray-800 */
				padding: 1.5rem; /* p-6 */
				border-radius: 0.5rem; /* rounded-lg */
				width: 100%;
				max-width: 24rem; /* max-w-sm */
				position: relative;
				box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5);
			}
			#pin-modal .modal-content input {
				width: 100%;
				padding: 0.5rem; /* p-2 */
				border: 1px solid #4b5563; /* border-gray-600 */
				background: #111827; /* bg-gray-900 */
				color: #ffffff;
				border-radius: 0.375rem; /* rounded-md */
				margin-bottom: 1rem; /* mb-4 */
			}
			#pin-modal .modal-content .error-message {
				color: #f87171; /* text-red-400 */
				font-size: 0.875rem; /* text-sm */
				margin-bottom: 1rem; /* mb-4 */
				display: none;
			}
			#pin-modal .modal-content .modal-buttons {
				display: flex;
				gap: 1rem; /* space-x-4 */
				justify-content: flex-end;
			}
			/* Song card styles for queue */
			#queue-results .song-card {
				position: relative; /* Contain absolute-positioned seek bar */
				padding-bottom: 1rem; /* Space for seek bar */
			}
			/* Seek bar styles */
			.seek-bar {
				position: absolute;
				left: 0;
				right: 0;
				bottom: 4px; /* Position above the bottom padding */
				height: 3px;
				background: #97aac6; /* bg-gray-600 */
				border-radius: 2px;
				overflow: hidden;
				pointer-events: none; /* Non-interactive */
			}
			.seek-bar-progress {
				height: 100%;
				background: #6d28d9; /* bg-purple-600 */
				width: 0%;
				border-radius: 2px;
				transition: width 0.5s linear;
			}
			/* Ensure queue position badge stays above seek bar */
			#queue-results .song-card .flex.items-center {
				position: relative;
				z-index: 1;
			}
			/* Reorder button styles */
			.reorder-btn {
				width: 2rem;
				height: 2rem;
				display: flex;
				align-items: center;
				justify-content: center;
				background-color: #4b5563; /* bg-gray-600 */
				color: #ffffff;
				border-radius: 0.25rem;
				margin-left: 0.5rem;
				transition: background-color 0.2s;
			}
			.reorder-btn:hover:not(.disabled-btn) {
				background-color: #6b7280; /* bg-gray-500 */
			}
			.reorder-btn.disabled-btn {
				opacity: 0.5;
				cursor: not-allowed;
				pointer-events: none;
			}
			.reorder-btn svg {
				width: 1rem;
				height: 1rem;
			}
		</style>
	</head>
	<body class="flex flex-col h-screen bg-gray-900 text-gray-100">
		<!-- Toast Message Overlay -->
		<div id="message-container" class="p-3 rounded text-sm hidden" aria-live="polite"></div>

		<header class="bg-purple-900 text-white p-4 shadow-md">
			<div class="container mx-auto flex flex-col md:flex-row justify-between items-center">
				<h1 class="text-2xl font-bold flex items-center">
					<svg
						xmlns="http://www.w3.org/2000/svg"
						class="h-6 w-6 mr-2"
						fill="none"
						viewBox="0 0 24 24"
						stroke="currentColor"
					>
						<path
							stroke-linecap="round"
							stroke-linejoin="round"
							stroke-width="2"
							d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"
						/>
					</svg>
					Select a song
				</h1>
				<div class="flex items-center mt-2 md:mt-0">
					<div class="mr-2 text-sm text-gray-300">Session:</div>
					<div
						id="session-id-header"
						class="bg-gray-800 px-3 py-1 rounded text-purple-300 font-mono text-sm"
					></div>
					<button
						id="session-panel-toggle"
						class="ml-2 bg-purple-800 hover:bg-purple-700 text-white px-2 py-1 rounded text-xs flex items-center"
					>
						<svg
							xmlns="http://www.w3.org/2000/svg"
							class="h-4 w-4"
							fill="none"
							viewBox="0 0 24 24"
							stroke="currentColor"
						>
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M19 9l-7 7-7-7"
							/>
						</svg>
					</button>
				</div>
			</div>
		</header>

		<!-- Session Panel (collapsible) -->
		<div id="session-panel" class="bg-gray-800 border-b border-gray-700 p-4 hidden">
			<div class="container mx-auto">
				<h2 class="text-lg font-semibold mb-3 text-purple-300">Session Management</h2>
				<div class="bg-gray-700 p-4 rounded-lg">
					<div class="flex items-center justify-between mb-2">
						<p class="font-medium text-gray-300">Current Session ID:</p>
						<span
							id="session-id"
							class="bg-gray-800 px-3 py-1 rounded text-purple-300 font-mono"
						></span>
					</div>
					<div class="flex items-center justify-between">
						<div class="flex-1 mr-2">
							<input
								type="text"
								id="new-session-input"
								class="w-full border border-gray-600 bg-gray-800 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 placeholder-gray-500"
								placeholder="Enter new session ID..."
							/>
						</div>
						<button
							id="change-session-btn"
							class="bg-purple-700 text-white px-4 py-2 rounded-lg hover:bg-purple-800 focus:outline-none focus:ring-2 focus:ring-purple-500 flex items-center"
						>
							<svg
								xmlns="http://www.w3.org/2000/svg"
								class="h-5 w-5 mr-1"
								fill="none"
								viewBox="0 0 24 24"
								stroke="currentColor"
							>
								<path
									stroke-linecap="round"
									stroke-linejoin="round"
									stroke-width="2"
									d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
								/>
							</svg>
							Change Session
						</button>
					</div>
					<p class="text-sm text-gray-400 mt-2">
						This session ID is stored locally and used to manage your song queue.
					</p>
				</div>
				<div class="mt-4">
					<button
						id="new-session-btn"
						class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 text-sm"
					>
						Generate New Session ID
					</button>
				</div>
			</div>
		</div>

		<div class="flex justify-center space-x-4 py-4 bg-gray-900 mx-2">
			<button
				id="search-tab-btn"
				class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-2 rounded-md text-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-32 sm:w-46"
			>
				<span>Search</span>
			</button>
			<button
				id="queue-tab-btn"
				class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-2 rounded-md text-lg focus:outline-none focus:ring-2 focus:ring-gray-500 w-32 sm:w-46"
			>
				Queue (<span id="queue-count">0</span>)
			</button>
			<button
				id="catalog-tab-btn"
				class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-2 rounded-md text-lg focus:outline-none focus:ring-2 focus:ring-gray-500 w-32 sm:w-46"
			>
				Catalog
			</button>
		</div>

		<!-- Search Input (Always Visible) -->
		<div class="search-input-container container mx-auto px-4 py-2">
			<div class="relative">
				<div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
					<svg
						xmlns="http://www.w3.org/2000/svg"
						class="h-5 w-5 text-gray-400"
						fill="none"
						viewBox="0 0 24 24"
						stroke="currentColor"
					>
						<path
							stroke-linecap="round"
							stroke-linejoin="round"
							stroke-width="2"
							d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
						/>
					</svg>
				</div>
				<input
					type="text"
					id="search-input"
					class="w-full bg-gray-900 border border-blue-500 rounded-lg pl-10 pr-10 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-400"
					placeholder="Search songs..."
				/>
				<div
					class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none hidden"
					id="search-spinner"
				>
					<svg
						class="animate-spin h-5 w-5 text-white"
						xmlns="http://www.w3.org/2000/svg"
						fill="none"
						viewBox="0 0 24 24"
					>
						<circle
							class="opacity-25"
							cx="12"
							cy="12"
							r="10"
							stroke="currentColor"
							stroke-width="4"
						></circle>
						<path
							class="opacity-75"
							fill="currentColor"
							d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
						></path>
					</svg>
				</div>
			</div>
		</div>

		<main class="flex-1 container mx-auto p-4">
			<!-- Search Section -->
			<div
				id="search-section"
				class="bg-gray-800 rounded-lg shadow-lg p-6 border border-gray-700 mb-4 min-h-full"
			>
				<div class="results-heading-container">
					<h2 id="results-heading" class="text-2xl font-bold mb-4 text-white"></h2>
				</div>
				<div class="results-scroll-container" style="max-height: calc(100vh - 320px)">
					<div id="search-results" class="space-y-2"></div>
					<div id="no-results" class="text-center py-8 text-gray-400 hidden">
						No songs found matching your search. Try different keywords.
					</div>
				</div>
			</div>

			<!-- Queue Section -->
			<div
				id="queue-section"
				class="bg-gray-800 rounded-lg shadow-lg p-6 border border-gray-700 hidden"
			>
				<h2 class="text-2xl font-bold mb-4 text-white">Current Queue</h2>
				<div id="queue-results" class="space-y-2"></div>
				<div id="empty-queue" class="text-center py-8 text-gray-400">
					Your queue is empty. Search for songs to add to your queue.
				</div>
				<div class="playback-controls">
					<button
						id="play-pause-btn"
						class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
						aria-label="Play or Pause"
					>
						<span class="btn-text">Play/Pause</span>
						<svg
							class="btn-icon hidden h-8 w-8"
							width="124px"
							height="124px"
							viewBox="-2.4 -2.4 28.80 28.80"
							fill="none"
							xmlns="http://www.w3.org/2000/svg"
							stroke="#af6e6e"
						>
							<g id="SVGRepo_bgCarrier" stroke-width="0" transform="translate(0,0), scale(1)"></g>
							<g
								id="SVGRepo_tracerCarrier"
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke="#CCCCCC"
								stroke-width="0.096"
							></g>
							<g id="SVGRepo_iconCarrier">
								<path
									d="M15 5V19M21 5V19M3 7.20608V16.7939C3 17.7996 3 18.3024 3.19886 18.5352C3.37141 18.7373 3.63025 18.8445 3.89512 18.8236C4.20038 18.7996 4.55593 18.4441 5.26704 17.733L10.061 12.939C10.3897 12.6103 10.554 12.446 10.6156 12.2565C10.6697 12.0898 10.6697 11.9102 10.6156 11.7435C10.554 11.554 10.3897 11.3897 10.061 11.061L5.26704 6.26704C4.55593 5.55593 4.20038 5.20038 3.89512 5.17636C3.63025 5.15551 3.37141 5.26273 3.19886 5.46476C3 5.69759 3 6.20042 3 7.20608Z"
									stroke="#fbfcfc"
									stroke-width="2"
									stroke-linecap="round"
									stroke-linejoin="round"
								></path>
							</g>
						</svg>
					</button>
					<button
						id="repeat-btn"
						class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
						aria-label="Repeat"
					>
						<span class="btn-text">Repeat</span>
						<svg
							class="btn-icon hidden h-8 w-8"
							width="128px"
							height="128px"
							viewBox="-2.4 -2.4 28.80 28.80"
							version="1.1"
							xmlns="http://www.w3.org/2000/svg"
							xmlns:xlink="http://www.w3.org/1999/xlink"
							fill="#000000"
						>
							<g id="SVGRepo_bgCarrier" stroke-width="0"></g>
							<g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
							<g id="SVGRepo_iconCarrier">
								<title>Repeat-Play</title>
								<g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
									<g id="Repeat-Play">
										<rect
											id="Rectangle"
											fill-rule="nonzero"
											x="0"
											y="0"
											width="24"
											height="24"
										></rect>
										<path
											d="M5,18.0002 L17,18.0002 C18.6569,18.0002 20,16.657 20,15.0002 L20,14"
											id="Path"
											stroke="#fbfcfc"
											stroke-width="2"
											stroke-linecap="round"
										></path>
										<path
											d="M16,2 L19.2929,5.29289 C19.6834,5.68342 19.6834,6.31658 19.2929,6.70711 L16,10"
											id="Path"
											stroke="#fbfcfc"
											stroke-width="2"
											stroke-linecap="round"
										></path>
										<path
											d="M8,14 L4.70711,17.2929 C4.31658,17.6834 4.31658,18.3166 4.70711,18.7071 L8,22"
											id="Path"
											stroke="#fbfcfc"
											stroke-width="2"
											stroke-linecap="round"
										></path>
										<path
											d="M19,6 L7,6 C5.34315,6 4,7.34315 4,9 L4,10"
											id="Path"
											stroke="#fbfcfc"
											stroke-width="2"
											stroke-linecap="round"
										></path>
									</g>
								</g>
							</g>
						</svg>
					</button>
					<button
						id="play-next-btn"
						class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
						aria-label="Play Next"
					>
						<span class="btn-text">Play Next</span>
						<svg
							class="btn-icon hidden h-8 w-8"
							width="124px"
							height="124px"
							viewBox="-2.4 -2.4 28.80 28.80"
							fill="none"
							xmlns="http://www.w3.org/2000/svg"
						>
							<g id="SVGRepo_bgCarrier" stroke-width="0"></g>
							<g
								id="SVGRepo_tracerCarrier"
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke="#CCCCCC"
								stroke-width="0.096"
							></g>
							<g id="SVGRepo_iconCarrier">
								<path
									d="m3 5 10 7-10 7V5Z"
									fill="#fcfcfc"
									fill-opacity=".16"
									stroke="#fcfcfc"
									stroke-width="1.5"
									stroke-linejoin="round"
								></path>
								<path
									d="M20.2 5h-2.4a.8.8 0 0 0-.8.8v12.4a.8.8 0 0 0 .8.8h2.4a.8.8 0 0 0 .8-.8V5.8a.8.8 0 0 0-.8-.8Z"
									fill="#ffffff"
									stroke="#fcfcfc"
									stroke-width="1.5"
									stroke-miterlimit="10"
								></path>
							</g>
						</svg>
					</button>
					<div id="playback-overlay" class="playback-overlay">
						<svg
							width="28"
							height="28"
							viewBox="0 0 24 24"
							fill="none"
							xmlns="http://www.w3.org/2000/svg"
						>
							<g id="SVGRepo_bgCarrier" stroke-width="0"></g>
							<g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
							<g id="SVGRepo_iconCarrier">
								<path
									d="M12 14.5V16.5M7 10.0288C7.47142 10 8.05259 10 8.8 10H15.2C15.9474 10 16.5286 10 17 10.0288M7 10.0288C6.41168 10.0647 5.99429 10.1455 5.63803 10.327C5.07354 10.6146 4.6146 11.0735 4.32698 11.638C4 12.2798 4 13.1198 4 14.8V16.2C4 17.8802 4 18.7202 4.32698 19.362C4.6146 19.9265 5.07354 20.3854 5.63803 20.673C6.27976 21 7.11984 21 8.8 21H15.2C16.8802 21 17.7202 21 18.362 20.673C18.9265 20.3854 19.3854 19.9265 19.673 19.362C20 18.7202 20 17.8802 20 16.2V14.8C20 13.1198 20 12.2798 19.673 11.638C19.3854 11.0735 18.9265 10.6146 18.362 10.327C18.0057 10.1455 17.5883 10.0647 17 10.0288M7 10.0288V8C7 5.23858 9.23858 3 12 3C14.7614 3 17 5.23858 17 8V10.0288"
									stroke="#f2f2f2"
									stroke-width="2"
									stroke-linecap="round"
									stroke-linejoin="round"
								></path>
							</g>
						</svg>
					</div>
				</div>
			</div>

			<!-- PIN Modal -->
			<div id="pin-modal" class="hidden">
				<div class="modal-backdrop"></div>
				<div class="modal-content">
					<h2 class="text-xl font-bold text-white mb-4">Enter PIN to Unlock Playback</h2>
					<input
						type="password"
						id="pin-input"
						class="focus:outline-none focus:ring-2 focus:ring-blue-500"
						placeholder="Enter PIN"
						autocomplete="off"
					/>
					<div id="pin-error" class="error-message">Incorrect PIN. Please try again.</div>
					<div class="modal-buttons">
						<button
							id="pin-cancel-btn"
							class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-500"
						>
							Cancel
						</button>
						<button
							id="pin-submit-btn"
							class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
						>
							Submit
						</button>
					</div>
				</div>
			</div>

			<div
				id="catalog-section"
				class="bg-gray-800 rounded-lg shadow-lg p-6 border border-gray-700 hidden"
			>
				<div class="flex items-center justify-between mb-4">
					<h2 class="text-2xl font-bold text-white">Song Catalog</h2>
					<div class="flex space-x-2">
						<button
							id="collapse-all-btn"
							class="bg-gray-600 hover:bg-gray-700 text-white px-2 py-1 rounded text-sm flex items-center"
						>
							<svg
								xmlns="http://www.w3.org/2000/svg"
								class="h-4 w-4 mr-1"
								fill="none"
								viewBox="0 0 24 24"
								stroke="currentColor"
							>
								<path
									stroke-linecap="round"
									stroke-linejoin="round"
									stroke-width="2"
									d="M5 15l7-7 7 7"
								/>
							</svg>
							Collapse All
						</button>
						<button
							id="refresh-catalog-btn"
							class="bg-gray-600 hover:bg-gray-700 text-white px-2 py-1 rounded text-sm flex items-center"
						>
							<svg
								xmlns="http://www.w3.org/2000/svg"
								class="h-4 w-4 mr-1"
								fill="none"
								viewBox="0 0 24 24"
								stroke="currentColor"
							>
								<path
									stroke-linecap="round"
									stroke-linejoin="round"
									stroke-width="2"
									d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
								/>
							</svg>
							Refresh
						</button>
					</div>
				</div>
				<div class="alpha-filter-container">
					<div id="alpha-filters" class="flex flex-wrap justify-center"></div>
				</div>
				<div id="catalog-results" class="space-y-4 mt-4"></div>
				<div id="no-catalog-results" class="text-center py-8 text-gray-400 hidden">
					No artists found for this filter.
				</div>
			</div>
		</main>

		<footer class="bg-gray-900 text-gray-400 p-4 text-center text-sm border-t border-gray-800">
			© <span id="current-year"></span> - Karaoke Master
		</footer>

		<script>
			// Global variables
			let sessionId = '';
			let socket = null;
			let searchResults = [];
			let queueItems = [];
			let catalogSongs = [];
			let isSearching = false;
			let isFetchingCatalog = false;
			let focusedSongIndex = -1;
			let currentFilterLetter = 'A';
			const HARDCODED_PIN = '1234'; // Hardcoded PIN for unlocking playback

			// DOM elements
			const searchInput = document.getElementById('search-input');
			const searchSpinner = document.getElementById('search-spinner');
			const messageContainer = document.getElementById('message-container');
			const resultsHeading = document.getElementById('results-heading');
			const searchResultsContainer = document.getElementById('search-results');
			const noResults = document.getElementById('no-results');
			const sessionIdElement = document.getElementById('session-id');
			const sessionIdHeaderElement = document.getElementById('session-id-header');
			const currentYearElement = document.getElementById('current-year');
			const newSessionInput = document.getElementById('new-session-input');
			const changeSessionBtn = document.getElementById('change-session-btn');
			const newSessionBtn = document.getElementById('new-session-btn');
			const sessionPanelToggle = document.getElementById('session-panel-toggle');
			const sessionPanel = document.getElementById('session-panel');
			const searchTabBtn = document.getElementById('search-tab-btn');
			const queueTabBtn = document.getElementById('queue-tab-btn');
			const catalogTabBtn = document.getElementById('catalog-tab-btn');
			const searchSection = document.getElementById('search-section');
			const queueSection = document.getElementById('queue-section');
			const catalogSection = document.getElementById('catalog-section');
			const queueResults = document.getElementById('queue-results');
			const emptyQueue = document.getElementById('empty-queue');
			const queueCount = document.getElementById('queue-count');
			const alphaFilters = document.getElementById('alpha-filters');
			const catalogResults = document.getElementById('catalog-results');
			const noCatalogResults = document.getElementById('no-catalog-results');
			const refreshCatalogBtn = document.getElementById('refresh-catalog-btn');
			const collapseAllBtn = document.getElementById('collapse-all-btn');
			const searchInputContainer = document.querySelector('.search-input-container');
			const playPauseBtn = document.getElementById('play-pause-btn');
			const repeatBtn = document.getElementById('repeat-btn');
			const playNextBtn = document.getElementById('play-next-btn');
			const playbackOverlay = document.getElementById('playback-overlay');
			const pinModal = document.getElementById('pin-modal');
			const pinInput = document.getElementById('pin-input');
			const pinSubmitBtn = document.getElementById('pin-submit-btn');
			const pinCancelBtn = document.getElementById('pin-cancel-btn');
			const pinError = document.getElementById('pin-error');

			// Set current year in footer
			currentYearElement.textContent = new Date().getFullYear();

			// Initialize the application
			function init() {
				// Get or create session ID
				sessionId = localStorage.getItem('karaoke-session-id');
				if (!sessionId) {
					sessionId = generateSessionId();
					localStorage.setItem('karaoke-session-id', sessionId);
				}
				// Update both session ID displays
				sessionIdElement.textContent = sessionId;
				sessionIdHeaderElement.textContent = sessionId;

				// Initialize socket connection
				initSocketConnection();
				fetchQueue(); // Load queue on page load/refresh

				// Initialize playback controls lock
				const isUnlocked = localStorage.getItem('playback-unlocked') === 'true';
				if (isUnlocked) {
					playbackOverlay.classList.add('hidden');
				}

				// Add event listeners
				searchInput.addEventListener('keypress', (e) => {
					if (e.key === 'Enter') {
						handleSearch();
					}
				});
				searchInput.addEventListener('focus', () => {
					searchInput.select();
				});
				searchInput.addEventListener('keydown', (e) => {
					if (e.key === 'Escape') {
						searchInput.value = '';
						clearResults();
						focusedSongIndex = -1;
					}
				});

				// Add event listeners for session management
				changeSessionBtn.addEventListener('click', changeSession);
				newSessionBtn.addEventListener('click', createNewSession);

				// Toggle session panel
				sessionPanelToggle.addEventListener('click', toggleSessionPanel);

				// Tab navigation
				searchTabBtn.addEventListener('click', showSearchTab);
				queueTabBtn.addEventListener('click', showQueueTab);
				catalogTabBtn.addEventListener('click', showCatalogTab);

				// Refresh catalog
				refreshCatalogBtn.addEventListener('click', () => {
					localStorage.removeItem('karaoke-catalog');
					fetchCatalog();
				});

				// Collapse all artist groups
				collapseAllBtn.addEventListener('click', () => {
					const artistSongs = catalogResults.querySelectorAll('.artist-songs');
					const toggleIcons = catalogResults.querySelectorAll('.artist-group-header svg');
					artistSongs.forEach((songsDiv) => songsDiv.classList.add('hidden'));
					toggleIcons.forEach((icon) => icon.classList.remove('rotate-180'));
				});

				// Playback controls
				playPauseBtn.addEventListener('click', () => {
					if (socket && socket.connected) {
						socket.emit('playback-control', { sessionID: sessionId, action: 'play_pause' });
						showMessage('Play/Pause action sent', 'info');
					} else {
						showMessage('Not connected to server', 'error');
					}
				});

				repeatBtn.addEventListener('click', () => {
					if (socket && socket.connected) {
						socket.emit('playback-control', { sessionID: sessionId, action: 'play_repeat' });
						showMessage('Repeat action sent', 'info');
					} else {
						showMessage('Not connected to server', 'error');
					}
				});
				playNextBtn.addEventListener('click', () => {
					if (socket && socket.connected) {
						socket.emit('playback-control', { sessionID: sessionId, action: 'play_next' });
						showMessage('Play Next action sent', 'info');
					} else {
						showMessage('Not connected to server', 'error');
					}
				});

				// Playback overlay and modal
				playbackOverlay.addEventListener('click', showPinModal);
				pinSubmitBtn.addEventListener('click', handlePinSubmit);
				pinCancelBtn.addEventListener('click', hidePinModal);
				pinInput.addEventListener('keypress', (e) => {
					if (e.key === 'Enter') {
						handlePinSubmit();
					}
				});

				// Keyboard navigation for song cards
				document.addEventListener('keydown', handleKeyboardNavigation);
			}

			// Show PIN modal
			function showPinModal() {
				pinModal.classList.add('show');
				pinInput.value = '';
				pinError.style.display = 'none';
				pinInput.focus();
			}

			// Hide PIN modal
			function hidePinModal() {
				pinModal.classList.remove('show');
				pinInput.value = '';
				pinError.style.display = 'none';
			}

			// Handle PIN submission
			function handlePinSubmit() {
				const enteredPin = pinInput.value.trim();
				if (enteredPin === HARDCODED_PIN) {
					playbackOverlay.classList.add('hidden');
					localStorage.setItem('playback-unlocked', 'true');
					hidePinModal();
					showMessage('Playback controls unlocked', 'success');
				} else {
					pinError.style.display = 'block';
					pinInput.value = '';
					pinInput.focus();
				}
			}

			// Keyboard navigation
			function handleKeyboardNavigation(e) {
				const activeSection = !searchSection.classList.contains('hidden')
					? searchResultsContainer
					: !catalogSection.classList.contains('hidden')
					? catalogResults
					: null;
				if (!activeSection) return;

				const songCards = activeSection.querySelectorAll('.song-card, .catalog-song-card');
				if (songCards.length === 0) return;

				if (e.key === 'ArrowDown') {
					e.preventDefault();
					focusedSongIndex = Math.min(focusedSongIndex + 1, songCards.length - 1);
					songCards[focusedSongIndex].focus();
					songCards[focusedSongIndex].scrollIntoView({ block: 'nearest' });
				} else if (e.key === 'ArrowUp') {
					e.preventDefault();
					focusedSongIndex = Math.max(focusedSongIndex - 1, 0);
					songCards[focusedSongIndex].focus();
					songCards[focusedSongIndex].scrollIntoView({ block: 'nearest' });
				} else if (e.key === 'Enter' && focusedSongIndex >= 0) {
					e.preventDefault();
					const addButton = songCards[focusedSongIndex].querySelector('.add-to-queue-btn');
					if (addButton && !addButton.disabled) {
						addButton.click();
					}
				}
			}

			function showSearchTab() {
				searchSection.classList.remove('hidden');
				queueSection.classList.add('hidden');
				catalogSection.classList.add('hidden');
				searchTabBtn.classList.replace('bg-gray-700', 'bg-blue-600');
				searchTabBtn.classList.replace('hover:bg-gray-600', 'hover:bg-blue-700');
				queueTabBtn.classList.replace('bg-blue-600', 'bg-gray-700');
				queueTabBtn.classList.replace('hover:bg-blue-700', 'hover:bg-gray-600');
				catalogTabBtn.classList.replace('bg-blue-600', 'bg-gray-700');
				catalogTabBtn.classList.replace('hover:bg-blue-700', 'hover:bg-gray-600');
				searchInputContainer.classList.remove('hidden'); // Show search input
				focusedSongIndex = -1;
				displaySearchResults(); // Restore search results if any
			}

			function showQueueTab() {
				searchSection.classList.add('hidden');
				queueSection.classList.remove('hidden');
				catalogSection.classList.add('hidden');
				searchTabBtn.classList.replace('bg-blue-600', 'bg-gray-700');
				searchTabBtn.classList.replace('hover:bg-blue-700', 'hover:bg-gray-600');
				queueTabBtn.classList.replace('bg-gray-700', 'bg-blue-600');
				queueTabBtn.classList.replace('hover:bg-gray-600', 'hover:bg-blue-700');
				catalogTabBtn.classList.replace('bg-blue-600', 'bg-gray-700');
				catalogTabBtn.classList.replace('hover:bg-blue-700', 'hover:bg-gray-600');
				searchInputContainer.classList.add('hidden'); // Hide search input
				fetchQueue();
				focusedSongIndex = -1;
			}

			function showCatalogTab() {
				searchSection.classList.add('hidden');
				queueSection.classList.add('hidden');
				catalogSection.classList.remove('hidden');
				searchTabBtn.classList.replace('bg-blue-600', 'bg-gray-700');
				searchTabBtn.classList.replace('hover:bg-blue-700', 'hover:bg-gray-600');
				queueTabBtn.classList.replace('bg-blue-600', 'bg-gray-700');
				queueTabBtn.classList.replace('hover:bg-blue-700', 'hover:bg-gray-600');
				catalogTabBtn.classList.replace('bg-gray-700', 'bg-blue-600');
				catalogTabBtn.classList.replace('hover:bg-gray-600', 'hover:bg-blue-700');
				searchInputContainer.classList.add('hidden'); // Hide search input
				const savedCatalog = localStorage.getItem('karaoke-catalog');
				if (savedCatalog) {
					try {
						catalogSongs = JSON.parse(savedCatalog);
						displayCatalog();
					} catch (error) {
						console.error('Error parsing saved catalog:', error);
						localStorage.removeItem('karaoke-catalog');
						fetchCatalog();
					}
				} else {
					fetchCatalog();
				}
				focusedSongIndex = -1;
			}

			function toggleSessionPanel() {
				const isVisible = !sessionPanel.classList.contains('hidden');
				if (isVisible) {
					sessionPanel.classList.add('hidden');
					localStorage.setItem('session-panel-open', 'false');
				} else {
					sessionPanel.classList.remove('hidden');
					localStorage.setItem('session-panel-open', 'true');
				}
				updateToggleButton(!isVisible);
			}

			function updateToggleButton(isOpen) {
				sessionPanelToggle.innerHTML = isOpen
					? '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" /></svg>'
					: '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>';
			}

			function generateSessionId() {
				return `session-${Date.now()}-${Math.random().toString(36).substring(2, 15)}`;
			}

			function changeSession() {
				const newSessionId = newSessionInput.value.trim();

				if (!newSessionId) {
					showMessage('Please enter a valid session ID', 'error');
					return;
				}

				sessionId = newSessionId;
				localStorage.setItem('karaoke-session-id', sessionId);
				sessionIdElement.textContent = sessionId;
				sessionIdHeaderElement.textContent = sessionId;

				// Clear the input
				newSessionInput.value = '';
				fetchQueue();
				if (!sessionPanel.classList.contains('hidden')) {
					toggleSessionPanel();
				}
				showMessage('Session changed successfully', 'success');
			}

			// Create a new session ID
			function createNewSession() {
				sessionId = generateSessionId();
				localStorage.setItem('karaoke-session-id', sessionId);
				sessionIdElement.textContent = sessionId;
				sessionIdHeaderElement.textContent = sessionId;
				fetchQueue();
				showMessage('New session created', 'success');
			}

			// Initialize socket.io connection
			function initSocketConnection() {
				// Get the server URL (same origin by default)
				const serverUrl = window.location.origin;

				// Connect to socket.io server
				socket = io(serverUrl, {
					auth: { token: 'karaoke-player-app' },
				});

				socket.on('connect', () => {
					console.log('Connected to socket server');
				});

				socket.on('error', (error) => {
					console.error('Socket connection error:', error);
					showMessage('Failed to connect to server. Some features may not work.', 'error');
				});

				socket.on('disconnect', () => {
					console.log('Disconnected from socket server');
				});

				socket.on('songQueueUpdated', (data) => {
					console.log('Song queue updated:', data);
					if (data.sessionID === sessionId) {
						updateQueueFromSocket(data);
					}
				});

				// Listen for playback progress updates
				socket.on('playback-progress', (data) => {
					if (data.sessionID === sessionId) {
						updateSeekBar(data);
					}
				});
			}

			// Update seek bar based on playback progress
			function updateSeekBar(data) {
				const { songid, currentTime, duration } = data;
				if (!songid || currentTime == null || duration == null || duration <= 0) {
					console.warn('Invalid playback progress data:', data);
					return;
				}

				// Remove existing seek bars from all song cards
				const allSeekBars = queueResults.querySelectorAll('.seek-bar');
				allSeekBars.forEach((seekBar) => seekBar.remove());

				// Find the song card with matching songid
				const songCard = queueResults.querySelector(`[data-song-id="${songid}"]`);
				if (!songCard) {
					console.warn(`No song card found for songid: ${songid}`);
					return;
				}

				// Only show seek bar if currentTime > 0 (indicating active playback)
				if (currentTime <= 0) {
					return;
				}

				// Calculate progress
				const progress = Math.min((currentTime / duration) * 100, 100);

				// Create seek bar if it doesn't exist
				const songDetails = songCard.querySelector('div:first-child');
				let seekBar = songCard.querySelector('.seek-bar');
				if (!seekBar) {
					seekBar = document.createElement('div');
					seekBar.className = 'seek-bar';
					seekBar.innerHTML = '<div class="seek-bar-progress"></div>';
					songDetails.appendChild(seekBar);
				}

				// Update progress bar width
				const seekBarProgress = seekBar.querySelector('.seek-bar-progress');
				if (seekBarProgress) {
					seekBarProgress.style.width = `${progress}%`;
				}
			}

			// Update queue based on socket message
			function updateQueueFromSocket(data) {
				if (data.action === 'add') {
					// Add the new song to queueItems
					queueItems.push(data.song);
					showMessage(
						`"${data.song.Title}" by ${data.song.Artist} added to queue! <a href="#" class="undo-link text-white underline" data-sequence-id="${data.song.sequenceID}">Undo</a>`,
						'success'
					);
				} else if (data.action === 'remove') {
					// Remove the song from queueItems
					queueItems = queueItems.filter((song) => song.sequenceID !== data.song.sequenceID);
					showMessage(`"${data.song.Title}" by ${data.song.Artist} removed from queue`, 'info');
				} else if (data.action === 'reorder') {
					fetchQueue(); // Refresh the queue to reflect the new order
					showMessage(`Queue reordered`, 'info');
				}

				// Update queue count
				updateQueueCount(data.count || queueItems.length);

				// Refresh display if on queue tab
				if (!queueSection.classList.contains('hidden')) {
					displayQueue();
				}
				// Re-render search and catalog results to update queued badges
				if (searchResults.length > 0) {
					displaySearchResults();
				}
				if (catalogSongs.length > 0) {
					displayCatalog();
				}
			}

			// Search for songs
			async function handleSearch() {
				console.log('Handling search...');
				const query = searchInput.value.trim();

				if (!query) {
					clearResults();
					return;
				}

				if (isSearching) return;
				isSearching = true;
				searchSpinner.classList.remove('hidden');
				try {
					const response = await fetch(`/api/songs/search?query=${encodeURIComponent(query)}`);

					if (!response.ok) {
						throw new Error('Search failed');
					}

					const data = await response.json();
					searchResults = data;
					displaySearchResults();
				} catch (error) {
					console.error('Error searching songs:', error);
					showMessage('Failed to search songs. Please check your network connection.', 'error');
				} finally {
					isSearching = false;
					searchSpinner.classList.add('hidden');
				}
			}

			// Display search results with the new UI
			function displaySearchResults() {
				console.log('Displaying search results...');
				if (searchResults.length > 0) {
					resultsHeading.innerHTML = `Search Results <span class="text-sm text-gray-400 ml-2">(${
						searchResults.length
					} song${searchResults.length === 1 ? '' : 's'})</span>`;
					searchResultsContainer.innerHTML = '';
					noResults.classList.add('hidden');

					searchResults.forEach((song, index) => {
						const songElement = document.createElement('div');
						songElement.className =
							'song-card border-b border-gray-700 py-2 flex justify-between items-center';
						songElement.tabIndex = 0;
						const duration =
							song.duration ||
							`${Math.floor(Math.random() * 5) + 2}:${Math.floor(Math.random() * 59)
								.toString()
								.padStart(2, '0')}`;
						const isQueued = queueItems.some((q) => q.songid === song.songid);
						songElement.innerHTML = `
							<div>
								<h3 class="text-xl font-bold text-white">${escapeHtml(song.Title || '')}</h3>
								<p class="text-gray-400">${escapeHtml(song.Artist || '')} • ${duration}</p>
								${isQueued ? '<span class="queued-badge">Queued</span>' : ''}
							</div>
							<button
								class="add-to-queue-btn bg-green-600 hover:bg-green-700 text-white h-10 w-12 mr-4 sm:w-28 flex items-center justify-center rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-200${
									isQueued ? ' disabled-btn' : ''
								}"
								data-song-id="${song.songid}"
								${isQueued ? 'disabled' : ''}
								title="Add to Queue"
							>
								<span class="text-full hidden sm:inline">Add to Queue</span>
								<span class="text-short sm:hidden">+</span>
								<svg class="spinner animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
									<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
									<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
								</svg>
							</button>
						`;
						const addButton = songElement.querySelector('.add-to-queue-btn');
						addButton.addEventListener('click', () => addToQueue(song, songElement, addButton));
						searchResultsContainer.appendChild(songElement);
					});

					// Restore focus if applicable
					if (focusedSongIndex >= 0 && focusedSongIndex < searchResults.length) {
						const songCards = searchResultsContainer.querySelectorAll('.song-card');
						songCards[focusedSongIndex].focus();
					}
				} else if (searchInput.value.trim() && !isSearching) {
					resultsHeading.textContent = '';
					searchResultsContainer.innerHTML = '';
					noResults.classList.remove('hidden');
				} else {
					clearResults();
				}
			}

			// Clear search results
			function clearResults() {
				resultsHeading.textContent = '';
				searchResultsContainer.innerHTML = '';
				noResults.classList.add('hidden');
				focusedSongIndex = -1;
			}

			async function fetchCatalog() {
				if (isFetchingCatalog) return;
				isFetchingCatalog = true;
				try {
					const response = await fetch('/api/songs/search?query=');
					if (!response.ok) {
						throw new Error('Failed to fetch catalog');
					}
					const data = await response.json();
					catalogSongs = data;
					localStorage.setItem('karaoke-catalog', JSON.stringify(data));
					displayCatalog();
				} catch (error) {
					console.error('Error fetching catalog:', error);
					showMessage('Failed to fetch song catalog. Please check your network.', 'error');
					catalogSongs = [];
					displayCatalog();
				} finally {
					isFetchingCatalog = false;
				}
			}

			function displayCatalog() {
				catalogResults.innerHTML = '';
				noCatalogResults.classList.add('hidden');

				// Group songs by artist
				const groupedByArtist = catalogSongs.reduce((acc, song) => {
					const artist = song.Artist || 'Unknown Artist';
					if (!acc[artist]) {
						acc[artist] = [];
					}
					acc[artist].push(song);
					return acc;
				}, {});

				// Sort artists alphabetically
				const sortedArtists = Object.keys(groupedByArtist).sort((a, b) =>
					a.toLowerCase().localeCompare(b.toLowerCase())
				);

				// Filter artists by current letter
				const filteredArtists = sortedArtists.filter((artist) => {
					if (currentFilterLetter === '#') {
						return !/^[a-zA-Z]/.test(artist) || !artist || artist === 'Unknown Artist';
					}
					return artist.toLowerCase().startsWith(currentFilterLetter.toLowerCase());
				});

				if (filteredArtists.length === 0) {
					noCatalogResults.classList.remove('hidden');
					return;
				}

				// Render artist groups
				filteredArtists.forEach((artist) => {
					const artistGroup = document.createElement('div');
					artistGroup.className = 'mb-2';
					const songs = groupedByArtist[artist];
					artistGroup.innerHTML = `
						<div class="artist-group-header bg-gray-700 px-4 py-2 rounded flex justify-between items-center">
							<span class="text-sm font-bold text-white">${escapeHtml(artist)}</span>
							<svg class="h-5 w-5 text-gray-400 transform transition-transform" data-artist="${escapeHtml(
								artist
							)}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
							</svg>
						</div>
						<div class="artist-songs mt-2" data-artist="${escapeHtml(artist)}"></div>
					`;

					const songsContainer = artistGroup.querySelector('.artist-songs');
					songs.forEach((song, index) => {
						const isLastSong = index === songs.length - 1;
						const songElement = document.createElement('div');
						songElement.className = `catalog-song-card ${
							isLastSong ? '' : 'border-b border-gray-700'
						} py-2 flex justify-between items-center`;
						songElement.tabIndex = 0;
						const duration =
							song.duration ||
							`${Math.floor(Math.random() * 5) + 2}:${Math.floor(Math.random() * 59)
								.toString()
								.padStart(2, '0')}`;
						const isQueued = queueItems.some((q) => q.songid === song.songid);
						songElement.innerHTML = `
							<div>
								<h4 class="text-sm text-white">${escapeHtml(song.Title || '')}</h4>
								<p class="song-details text-gray-400">${duration}</p>
								${isQueued ? '<span class="queued-badge catalog-queued-badge">Queued</span>' : ''}
							</div>
							<button
								class="add-to-queue-btn bg-green-600 hover:bg-green-700 text-white h-8 w-12 sm:w-28 flex items-center justify-center rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-200${
									isQueued ? ' disabled-btn' : ''
								}"
								data-song-id="${song.songid}"
								${isQueued ? 'disabled' : ''}
								title="Add to Queue"
							>
								<span class="text-full text-sm hidden sm:inline">Add to Queue</span>
								<span class="text-short sm:hidden">+</span>
								<svg class="spinner animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
									<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
									<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
								</svg>
							</button>
						`;
						const addButton = songElement.querySelector('.add-to-queue-btn');
						addButton.addEventListener('click', () => addToQueue(song, songElement, addButton));
						songsContainer.appendChild(songElement);
					});

					// Toggle artist songs visibility
					const header = artistGroup.querySelector('.artist-group-header');
					const toggleIcon = header.querySelector('svg');
					header.addEventListener('click', () => {
						const songsDiv = artistGroup.querySelector('.artist-songs');
						const isHidden = songsDiv.classList.contains('hidden');
						songsDiv.classList.toggle('hidden', !isHidden);
						toggleIcon.classList.toggle('rotate-180', isHidden);
					});

					catalogResults.appendChild(artistGroup);
				});

				// Scroll to top
				window.scrollTo({
					top: 0,
					behavior: 'smooth',
				});

				initializeAlphaFilters();
			}

			function initializeAlphaFilters() {
				alphaFilters.innerHTML = '';
				const letters = ['#', ...'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('')];
				letters.forEach((letter) => {
					const btn = document.createElement('button');
					btn.className = `alpha-filter-btn bg-gray-700 hover:bg-gray-600 text-white font-semibold ${
						letter === currentFilterLetter ? 'active' : ''
					}`;
					btn.textContent = letter;
					btn.addEventListener('click', () => filterCatalogByLetter(letter));
					alphaFilters.appendChild(btn);
				});
			}

			function filterCatalogByLetter(letter) {
				currentFilterLetter = letter;
				displayCatalog();
			}

			async function addToQueue(song, songElement, addButton) {
				if (!sessionId) {
					showMessage('Session ID not found. Please refresh the page.', 'error');
					return;
				}

				console.log('Adding song to queue:', song);
				// Disable the button
				addButton.disabled = true;
				addButton.classList.add('disabled-btn', 'loading');
				songElement.classList.add('animate-song-added');
				setTimeout(() => {
					songElement.classList.remove('animate-song-added');
				}, 1000);
				try {
					const response = await fetch('/api/songqueue', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({
							sessionId,
							songid: song.songid,
							Artist: song.Artist,
							Title: song.Title,
							filePath: song.path,
							status: 'pending',
							startTime: song.startTime || 0,
						}),
					});

					if (!response.ok) {
						throw new Error('Failed to add song to queue');
					}

					const data = await response.json();
					const sequenceID = data.sequenceID;
					fetchQueueCount();
					if (sequenceID) {
						showMessage(
							`"${song.Title}" by ${
								song.Artist || 'Unknown Artist'
							} added to queue! <a href="#" class="undo-link text-white underline" data-sequence-id="${sequenceID}">Undo</a>`,
							'success'
						);
					}
				} catch (error) {
					console.error('Error adding song to queue:', error);
					showMessage('Failed to add song to queue. Please try again.', 'error');
					addButton.disabled = false;
					addButton.classList.remove('disabled-btn', 'loading');
				}
			}

			async function undoQueueAddition(sequenceID) {
				try {
					const response = await fetch(`/api/songqueue/${sequenceID}`, {
						method: 'DELETE',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ sessionId }),
					});
					if (!response.ok) {
						throw new Error('Failed to remove song from queue');
					}
					fetchQueue();
				} catch (error) {
					console.error('Error removing song from queue:', error);
					showMessage('Failed to undo queue addition. Please try again.', 'error');
				}
			}

			async function reorderQueue(sequenceID, direction) {
				if (!sessionId) {
					showMessage('Session ID not found. Please refresh the page.', 'error');
					return;
				}

				try {
					const response = await fetch('/api/songqueue_reorder', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({
							sessionID: sessionId,
							sequenceID: sequenceID,
							direction: direction,
						}),
					});

					if (!response.ok) {
						throw new Error('Failed to reorder queue');
					}

					fetchQueue();
					showMessage(`Song moved ${direction}`, 'success');
				} catch (error) {
					console.error('Error reordering queue:', error);
					showMessage('Failed to reorder queue. Please try again.', 'error');
				}
			}

			async function fetchQueue() {
				if (!sessionId) {
					showMessage('Session ID not found. Please refresh the page.', 'error');
					return;
				}

				try {
					const response = await fetch(`/api/songqueue/session/${sessionId}`);

					if (!response.ok) {
						throw new Error('Failed to fetch queue');
					}

					const data = await response.json();
					queueItems = data;
					displayQueue();
					updateQueueCount(queueItems.length);
					if (searchResults.length > 0) {
						displaySearchResults();
					}
					if (catalogSongs.length > 0) {
						displayCatalog();
					}
				} catch (error) {
					console.error('Error fetching queue:', error);
					showMessage('Failed to fetch queue. Please check your network.', 'error');
					queueItems = [];
					displayQueue();
				}
			}

			// Just update the queue count
			async function fetchQueueCount() {
				if (!sessionId) return;

				try {
					const response = await fetch(`/api/songqueue/session/${sessionId}`);
					if (!response.ok) throw new Error('Failed to fetch queue count');

					const data = await response.json();
					updateQueueCount(data.length);
				} catch (error) {
					console.error('Error fetching queue count:', error);
				}
			}

			// Update queue count in UI
			function updateQueueCount(count) {
				queueCount.textContent = count;
			}

			// Display queue items
			function displayQueue() {
				queueResults.innerHTML = '';

				if (queueItems.length > 0) {
					emptyQueue.classList.add('hidden');

					queueItems.forEach((song, index) => {
						const queueItem = document.createElement('div');
						queueItem.className =
							'song-card border-b border-gray-700 py-2 flex justify-between items-center';
						queueItem.setAttribute('data-song-id', song.songid);
						queueItem.innerHTML = `
							<div>
								<h3 class="text-xl font-bold text-white">${escapeHtml(song.Title || '')}</h3>
								<p class="text-gray-400">${escapeHtml(song.Artist || '')}</p>
							</div>
							<div class="flex items-center">
								<button class="reorder-btn ${index === 0 ? 'disabled-btn' : ''}" 
									data-sequence-id="${song.sequenceID}" 
									data-direction="up"
									${index === 0 ? 'disabled' : ''}
									aria-label="Move song up in queue"
									title="Move Up">
									<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
									</svg>
								</button>
								<button class="reorder-btn ${index === queueItems.length - 1 ? 'disabled-btn' : ''}" 
									data-sequence-id="${song.sequenceID}" 
									data-direction="down"
									${index === queueItems.length - 1 ? 'disabled' : ''}
									aria-label="Move song down in queue"
									title="Move Down">
									<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
									</svg>
								</button>
								<span class="bg-purple-800 text-white px-3 py-1 rounded-md ml-2">#${index + 1}</span>
							</div>
						`;

						const upButton = queueItem.querySelector('button[data-direction="up"]');
						const downButton = queueItem.querySelector('button[data-direction="down"]');
						if (upButton) {
							upButton.addEventListener('click', () => reorderQueue(song.sequenceID, 'up'));
						}
						if (downButton) {
							downButton.addEventListener('click', () => reorderQueue(song.sequenceID, 'down'));
						}

						queueResults.appendChild(queueItem);
					});
				} else {
					emptyQueue.classList.remove('hidden');
				}
			}

			function showMessage(html, type) {
				messageContainer.innerHTML = html;
				messageContainer.className = `p-3 rounded text-sm message animate-slide-in ${
					type === 'success'
						? 'bg-green-800 text-green-100'
						: type === 'info'
						? 'bg-blue-800 text-blue-100'
						: 'bg-red-800 text-red-100'
				}`;
				messageContainer.classList.remove('hidden');

				const undoLink = messageContainer.querySelector('.undo-link');
				if (undoLink) {
					undoLink.addEventListener('click', (e) => {
						e.preventDefault();
						const sequenceID = undoLink.getAttribute('data-sequence-id');
						undoQueueAddition(sequenceID);
						messageContainer.classList.add('hidden');
					});
				}

				setTimeout(() => {
					messageContainer.classList.add('hidden');
					messageContainer.classList.remove('animate-slide-in');
				}, 3000);
			}

			// Helper function to escape HTML (prevent XSS)
			function escapeHtml(unsafe) {
				if (!unsafe) return '';
				return unsafe
					.replace(/&/g, '&amp;')
					.replace(/</g, '&lt;')
					.replace(/>/g, '&gt;')
					.replace(/"/g, '&quot;')
					.replace(/'/g, '&#039;');
			}

			// Initialize the app when the DOM is fully loaded
			document.addEventListener('DOMContentLoaded', init);
		</script>
	</body>
</html>
