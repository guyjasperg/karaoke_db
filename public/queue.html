<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Karaoke Master</title>
		<link
			href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css"
			rel="stylesheet"
		/>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.min.js"></script>
		<style>
			.animate-pulse {
				animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
			}
			@keyframes pulse {
				0%,
				100% {
					opacity: 1;
				}
				50% {
					opacity: 0.5;
				}
			}
			.message {
				transition: opacity 0.5s ease-in-out;
			}
			.hidden {
				display: none;
			}
			/* Custom scrollbar for dark theme */
			::-webkit-scrollbar {
				width: 8px;
				height: 8px;
			}
			::-webkit-scrollbar-track {
				background: #1f2937;
			}
			::-webkit-scrollbar-thumb {
				background: #4c1d95;
				border-radius: 4px;
			}
			::-webkit-scrollbar-thumb:hover {
				background: #5b21b6;
			}
			/* Ensure text visibility, override conflicting CSS */
			@media (min-width: 640px) {
				.add-to-queue-btn .text-full {
					display: inline !important;
				}
				.add-to-queue-btn .text-short {
					display: none !important;
				}
			}
			@media (max-width: 639px) {
				.add-to-queue-btn .text-full {
					display: none !important;
				}
				.add-to-queue-btn .text-short {
					display: inline !important;
				}
			}
			/* Ensure search input and results heading stay visible */
			.search-input-container {
				position: sticky;
				top: 0;
				z-index: 10;
				background: #111827; /* bg-gray-900 */
			}
			.results-heading-container {
				position: sticky;
				top: 0;
				z-index: 9;
				background: #1f2937; /* bg-gray-800 */
			}
			/* Scrollable results container */
			.results-scroll-container {
				overflow-y: auto;
			}
			/* Disabled button style */
			.disabled-btn {
				opacity: 0.5;
				cursor: not-allowed;
				pointer-events: none; /* Prevent hover/click */
			}
			/* Animation for song card when added to queue */
			.animate-song-added {
				animation: song-added 1s ease-in-out;
			}
			@keyframes song-added {
				0% {
					border-color: #10b981; /* green-500 */
					box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
				}
				50% {
					border-color: #34d399; /* green-400 */
					box-shadow: 0 0 12px rgba(52, 211, 153, 0.7);
				}
				100% {
					border-color: #4b5563; /* gray-600 */
					box-shadow: none;
				}
			}
			/* Toast message as overlay */
			#message-container {
				position: fixed;
				top: 16px;
				left: 50%;
				transform: translateX(-50%);
				z-index: 20;
				max-width: 90%;
				width: 320px; /* Fixed width for consistency */
				box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3); /* shadow-md equivalent */
			}
			/* Slide-in animation for toast */
			.animate-slide-in {
				animation: slide-in 0.5s ease-out;
			}
			@keyframes slide-in {
				0% {
					opacity: 0;
					transform: translateY(-20px) translateX(-50%);
				}
				100% {
					opacity: 1;
					transform: translateY(0) translateX(-50%);
				}
			}
			/* Queued badge */
			.queued-badge {
				display: inline-block;
				background-color: #8a60ac; /* green-700 */
				color: #ffffff;
				font-size: 0.75rem; /* text-xs */
				padding: 0.25rem 0.5rem; /* px-2 py-1 */
				border-radius: 0.375rem; /* rounded */
				margin-top: 0.25rem; /* mt-1 */
			}
			/* Focus style for song cards */
			.song-card:focus {
				outline: none;
				background-color: #374151; /* bg-gray-700 */
				box-shadow: 0 0 0 2px #3b82f6; /* ring-2 ring-blue-500 */
			}
			/* Spinner styles */
			.animate-spin {
				animation: spin 1s linear infinite;
			}
			@keyframes spin {
				0% {
					transform: rotate(0deg);
				}
				100% {
					transform: rotate(360deg);
				}
			}
			.add-to-queue-btn .spinner {
				display: none;
			}
			.add-to-queue-btn.loading .spinner {
				display: inline-block;
			}
			.add-to-queue-btn.loading .text-full,
			.add-to-queue-btn.loading .text-short {
				display: none;
			}
		</style>
	</head>
	<body class="flex flex-col h-screen bg-gray-900 text-gray-100">
		<!-- Toast Message Overlay -->
		<div id="message-container" class="p-3 rounded text-sm hidden" aria-live="polite"></div>

		<header class="bg-purple-900 text-white p-4 shadow-md">
			<div class="container mx-auto flex flex-col md:flex-row justify-between items-center">
				<h1 class="text-2xl font-bold flex items-center">
					<svg
						xmlns="http://www.w3.org/2000/svg"
						class="h-6 w-6 mr-2"
						fill="none"
						viewBox="0 0 24 24"
						stroke="currentColor"
					>
						<path
							stroke-linecap="round"
							stroke-linejoin="round"
							stroke-width="2"
							d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"
						/>
					</svg>
					Karaoke Master
				</h1>
				<div class="flex items-center mt-2 md:mt-0">
					<div class="mr-2 text-sm text-gray-300">Session:</div>
					<div
						id="session-id-header"
						class="bg-gray-800 px-3 py-1 rounded text-purple-300 font-mono text-sm"
					></div>
					<button
						id="session-panel-toggle"
						class="ml-2 bg-purple-800 hover:bg-purple-700 text-white px-2 py-1 rounded text-xs flex items-center"
					>
						<svg
							xmlns="http://www.w3.org/2000/svg"
							class="h-4 w-4"
							fill="none"
							viewBox="0 0 24 24"
							stroke="currentColor"
						>
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M19 9l-7 7-7-7"
							/>
						</svg>
					</button>
				</div>
			</div>
		</header>

		<!-- Session Panel (collapsible) -->
		<div id="session-panel" class="bg-gray-800 border-b border-gray-700 p-4 hidden">
			<div class="container mx-auto">
				<h2 class="text-lg font-semibold mb-3 text-purple-300">Session Management</h2>
				<div class="bg-gray-700 p-4 rounded-lg">
					<div class="flex items-center justify-between mb-2">
						<p class="font-medium text-gray-300">Current Session ID:</p>
						<span
							id="session-id"
							class="bg-gray-800 px-3 py-1 rounded text-purple-300 font-mono"
						></span>
					</div>
					<div class="flex items-center justify-between">
						<div class="flex-1 mr-2">
							<input
								type="text"
								id="new-session-input"
								class="w-full border border-gray-600 bg-gray-800 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 placeholder-gray-500"
								placeholder="Enter new session ID..."
							/>
						</div>
						<button
							id="change-session-btn"
							class="bg-purple-700 text-white px-4 py-2 rounded-lg hover:bg-purple-800 focus:outline-none focus:ring-2 focus:ring-purple-500 flex items-center"
						>
							<svg
								xmlns="http://www.w3.org/2000/svg"
								class="h-5 w-5 mr-1"
								fill="none"
								viewBox="0 0 24 24"
								stroke="currentColor"
							>
								<path
									stroke-linecap="round"
									stroke-linejoin="round"
									stroke-width="2"
									d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
								/>
							</svg>
							Change Session
						</button>
					</div>
					<p class="text-sm text-gray-400 mt-2">
						This session ID is stored locally and used to manage your song queue.
					</p>
				</div>
				<div class="mt-4">
					<button
						id="new-session-btn"
						class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 text-sm"
					>
						Generate New Session ID
					</button>
				</div>
			</div>
		</div>

		<div class="flex justify-center space-x-4 py-4 bg-gray-900">
			<button
				id="search-tab-btn"
				class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded-md text-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
			>
				Search Songs
			</button>
			<button
				id="queue-tab-btn"
				class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 px-8 rounded-md text-lg focus:outline-none focus:ring-2 focus:ring-gray-500"
			>
				Queue (<span id="queue-count">0</span>)
			</button>
		</div>

		<!-- Search Input (Always Visible) -->
		<div class="search-input-container container mx-auto px-4 py-2">
			<div class="relative">
				<div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
					<svg
						xmlns="http://www.w3.org/2000/svg"
						class="h-5 w-5 text-gray-400"
						fill="none"
						viewBox="0 0 24 24"
						stroke="currentColor"
					>
						<path
							stroke-linecap="round"
							stroke-linejoin="round"
							stroke-width="2"
							d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
						/>
					</svg>
				</div>
				<input
					type="text"
					id="search-input"
					class="w-full bg-gray-900 border border-blue-500 rounded-lg pl-10 pr-10 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-400"
					placeholder="Search songs..."
				/>
				<div
					class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none hidden"
					id="search-spinner"
				>
					<svg
						class="animate-spin h-5 w-5 text-white"
						xmlns="http://www.w3.org/2000/svg"
						fill="none"
						viewBox="0 0 24 24"
					>
						<circle
							class="opacity-25"
							cx="12"
							cy="12"
							r="10"
							stroke="currentColor"
							stroke-width="4"
						></circle>
						<path
							class="opacity-75"
							fill="currentColor"
							d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
						></path>
					</svg>
				</div>
			</div>
		</div>

		<main class="flex-1 container mx-auto p-4">
			<!-- Search Section -->
			<div
				id="search-section"
				class="bg-gray-800 rounded-lg shadow-lg p-6 border border-gray-700 mb-4 min-h-full"
			>
				<div class="results-heading-container">
					<h2 id="results-heading" class="text-2xl font-bold mb-4 text-white"></h2>
				</div>
				<div class="results-scroll-container" style="max-height: calc(100vh - 320px)">
					<div id="search-results" class="space-y-4"></div>
					<div id="no-results" class="text-center py-8 text-gray-400 hidden">
						No songs found matching your search. Try different keywords.
					</div>
				</div>
			</div>

			<!-- Queue Section -->
			<div
				id="queue-section"
				class="bg-gray-800 rounded-lg shadow-lg p-6 border border-gray-700 hidden"
			>
				<h2 class="text-2xl font-bold mb-4 text-white">Current Queue</h2>
				<div id="queue-results" class="space-y-4"></div>
				<div id="empty-queue" class="text-center py-8 text-gray-400">
					Your queue is empty. Search for songs to add to your queue.
				</div>
			</div>
		</main>

		<footer class="bg-gray-900 text-gray-400 p-4 text-center text-sm border-t border-gray-800">
			© <span id="current-year"></span> - Karaoke Master
		</footer>

		<script>
			// Global variables
			let sessionId = '';
			let socket = null;
			let searchResults = [];
			let queueItems = [];
			let isSearching = false;
			let focusedSongIndex = -1;

			// DOM elements
			const searchInput = document.getElementById('search-input');
			const searchSpinner = document.getElementById('search-spinner');
			const messageContainer = document.getElementById('message-container');
			const resultsHeading = document.getElementById('results-heading');
			const searchResultsContainer = document.getElementById('search-results');
			const noResults = document.getElementById('no-results');
			const sessionIdElement = document.getElementById('session-id');
			const sessionIdHeaderElement = document.getElementById('session-id-header');
			const currentYearElement = document.getElementById('current-year');
			const newSessionInput = document.getElementById('new-session-input');
			const changeSessionBtn = document.getElementById('change-session-btn');
			const newSessionBtn = document.getElementById('new-session-btn');
			const sessionPanelToggle = document.getElementById('session-panel-toggle');
			const sessionPanel = document.getElementById('session-panel');
			const searchTabBtn = document.getElementById('search-tab-btn');
			const queueTabBtn = document.getElementById('queue-tab-btn');
			const searchSection = document.getElementById('search-section');
			const queueSection = document.getElementById('queue-section');
			const queueResults = document.getElementById('queue-results');
			const emptyQueue = document.getElementById('empty-queue');
			const queueCount = document.getElementById('queue-count');

			// Set current year in footer
			currentYearElement.textContent = new Date().getFullYear();

			// Initialize the application
			function init() {
				// Get or create session ID
				sessionId = localStorage.getItem('karaoke-session-id');
				if (!sessionId) {
					sessionId = generateSessionId();
					localStorage.setItem('karaoke-session-id', sessionId);
				}
				// Update both session ID displays
				sessionIdElement.textContent = sessionId;
				sessionIdHeaderElement.textContent = sessionId;

				// Initialize socket connection
				initSocketConnection();
				fetchQueue(); // Load queue on page load/refresh

				// Add event listeners
				searchInput.addEventListener('keypress', (e) => {
					if (e.key === 'Enter') {
						handleSearch();
					}
				});
				searchInput.addEventListener('focus', () => {
					searchInput.select();
				});
				searchInput.addEventListener('keydown', (e) => {
					if (e.key === 'Escape') {
						searchInput.value = '';
						clearResults();
						focusedSongIndex = -1;
					}
				});

				// Add event listeners for session management
				changeSessionBtn.addEventListener('click', changeSession);
				newSessionBtn.addEventListener('click', createNewSession);

				// Toggle session panel
				sessionPanelToggle.addEventListener('click', toggleSessionPanel);

				// Tab navigation
				searchTabBtn.addEventListener('click', showSearchTab);
				queueTabBtn.addEventListener('click', showQueueTab);

				// Keyboard navigation for song cards
				document.addEventListener('keydown', handleKeyboardNavigation);

				const sessionPanelOpen = localStorage.getItem('session-panel-open') === 'true';
				if (sessionPanelOpen) {
					sessionPanel.classList.remove('hidden');
					updateToggleButton(true);
				}
			}

			// Keyboard navigation
			function handleKeyboardNavigation(e) {
				if (!searchSection.classList.contains('hidden')) {
					const songCards = searchResultsContainer.querySelectorAll('.song-card');
					if (songCards.length === 0) return;

					if (e.key === 'ArrowDown') {
						e.preventDefault();
						focusedSongIndex = Math.min(focusedSongIndex + 1, songCards.length - 1);
						songCards[focusedSongIndex].focus();
						songCards[focusedSongIndex].scrollIntoView({ block: 'nearest' });
					} else if (e.key === 'ArrowUp') {
						e.preventDefault();
						focusedSongIndex = Math.max(focusedSongIndex - 1, 0);
						songCards[focusedSongIndex].focus();
						songCards[focusedSongIndex].scrollIntoView({ block: 'nearest' });
					} else if (e.key === 'Enter' && focusedSongIndex >= 0) {
						e.preventDefault();
						const addButton = songCards[focusedSongIndex].querySelector('.add-to-queue-btn');
						if (addButton && !addButton.disabled) {
							addButton.click();
						}
					}
				}
			}

			function showSearchTab() {
				searchSection.classList.remove('hidden');
				queueSection.classList.add('hidden');
				searchTabBtn.classList.replace('bg-gray-700', 'bg-blue-600');
				searchTabBtn.classList.replace('hover:bg-gray-600', 'hover:bg-blue-700');
				queueTabBtn.classList.replace('bg-blue-600', 'bg-gray-700');
				queueTabBtn.classList.replace('hover:bg-blue-700', 'hover:bg-gray-600');
				focusedSongIndex = -1;
			}

			// Show queue tab
			function showQueueTab() {
				searchSection.classList.add('hidden');
				queueSection.classList.remove('hidden');
				searchTabBtn.classList.replace('bg-blue-600', 'bg-gray-700');
				searchTabBtn.classList.replace('hover:bg-blue-700', 'hover:bg-gray-600');
				queueTabBtn.classList.replace('bg-gray-700', 'bg-blue-600');
				queueTabBtn.classList.replace('hover:bg-gray-600', 'hover:bg-blue-700');
				fetchQueue();
				focusedSongIndex = -1;
			}

			// Toggle session panel visibility
			function toggleSessionPanel() {
				const isVisible = !sessionPanel.classList.contains('hidden');
				if (isVisible) {
					sessionPanel.classList.add('hidden');
					localStorage.setItem('session-panel-open', 'false');
				} else {
					sessionPanel.classList.remove('hidden');
					localStorage.setItem('session-panel-open', 'true');
				}
				updateToggleButton(!isVisible);
			}

			// Update toggle button icon
			function updateToggleButton(isOpen) {
				sessionPanelToggle.innerHTML = isOpen
					? '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" /></svg>'
					: '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>';
			}

			// Generate a new session ID
			function generateSessionId() {
				return `session-${Date.now()}-${Math.random().toString(36).substring(2, 15)}`;
			}

			// Change the current session
			function changeSession() {
				const newSessionId = newSessionInput.value.trim();

				if (!newSessionId) {
					showMessage('Please enter a valid session ID', 'error');
					return;
				}

				// Update session ID
				sessionId = newSessionId;
				localStorage.setItem('karaoke-session-id', sessionId);
				sessionIdElement.textContent = sessionId;
				sessionIdHeaderElement.textContent = sessionId;

				// Clear the input
				newSessionInput.value = '';
				fetchQueue(); // Refresh queue for new session
				if (!sessionPanel.classList.contains('hidden')) {
					toggleSessionPanel(); // Collapse session panel
				}
				showMessage('Session changed successfully', 'success');
			}

			// Create a new session ID
			function createNewSession() {
				sessionId = generateSessionId();
				localStorage.setItem('karaoke-session-id', sessionId);
				sessionIdElement.textContent = sessionId;
				sessionIdHeaderElement.textContent = sessionId;
				fetchQueue(); // Refresh queue for new session
				showMessage('New session created', 'success');
			}

			// Initialize socket.io connection
			function initSocketConnection() {
				// Get the server URL (same origin by default)
				const serverUrl = window.location.origin;

				// Connect to socket.io server
				socket = io(serverUrl, {
					auth: { token: 'karaoke-player-app' },
				});

				socket.on('connect', () => {
					console.log('Connected to socket server');
				});

				socket.on('error', (error) => {
					console.error('Socket connection error:', error);
					showMessage('Failed to connect to server. Some features may not work.', 'error');
				});

				socket.on('disconnect', () => {
					console.log('Disconnected from socket server');
				});

				socket.on('songQueueUpdated', (data) => {
					console.log('Song queue updated:', data);
					if (data.sessionID === sessionId) {
						updateQueueFromSocket(data);
					}
				});
			}

			// Update queue based on socket message
			function updateQueueFromSocket(data) {
				if (data.action === 'add') {
					// Add the new song to queueItems
					queueItems.push(data.song);
					showMessage(
						`"${data.song.Title}" by ${data.song.Artist} added to queue! <a href="#" class="undo-link text-white underline" data-sequence-id="${data.song.sequenceID}">Undo</a>`,
						'success'
					);
				} else if (data.action === 'remove') {
					// Remove the song from queueItems
					queueItems = queueItems.filter((song) => song.sequenceID !== data.song.sequenceID);
					showMessage(`"${data.song.Title}" by ${data.song.Artist} removed from queue`, 'info');
				}

				// Update queue count
				updateQueueCount(data.count || queueItems.length);

				// Refresh display if on queue tab
				if (!queueSection.classList.contains('hidden')) {
					displayQueue();
				}
				// Re-render search results to update queued badges
				if (searchResults.length > 0) {
					displaySearchResults();
				}
			}

			// Search for songs
			async function handleSearch() {
				const query = searchInput.value.trim();

				if (!query) {
					clearResults();
					return;
				}

				if (isSearching) return;
				isSearching = true;
				searchSpinner.classList.remove('hidden');
				try {
					const response = await fetch(`/api/songs/search?query=${encodeURIComponent(query)}`);

					if (!response.ok) {
						throw new Error('Search failed');
					}

					const data = await response.json();
					searchResults = data;

					// Display results
					displaySearchResults();
				} catch (error) {
					console.error('Error searching songs:', error);
					showMessage('Failed to search songs. Please check your network connection.', 'error');
				} finally {
					isSearching = false;
					searchSpinner.classList.add('hidden');
				}
			}

			// Display search results with the new UI
			function displaySearchResults() {
				if (searchResults.length > 0) {
					resultsHeading.innerHTML = `Search Results <span class="text-sm text-gray-400 ml-2">(${
						searchResults.length
					} song${searchResults.length === 1 ? '' : 's'})</span>`;
					searchResultsContainer.innerHTML = '';
					noResults.classList.add('hidden');

					searchResults.forEach((song, index) => {
						const songElement = document.createElement('div');
						songElement.className =
							'song-card border-b border-gray-700 py-4 flex justify-between items-center';
						songElement.tabIndex = 0;
						const duration =
							song.duration ||
							`${Math.floor(Math.random() * 5) + 2}:${Math.floor(Math.random() * 59)
								.toString()
								.padStart(2, '0')}`;
						const isQueued = queueItems.some((q) => q.songid === song.songid);
						songElement.innerHTML = `
							<div>
								<h3 class="text-xl font-bold text-white">${escapeHtml(song.Title || '')}</h3>
								<p class="text-gray-400">${escapeHtml(song.Artist || '')} • ${duration}</p>
								${isQueued ? '<span class="queued-badge">Queued</span>' : ''}
							</div>
							<button
								class="add-to-queue-btn bg-green-600 hover:bg-green-700 text-white h-10 w-12 sm:w-28 flex items-center justify-center rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-200${
									isQueued ? ' disabled-btn' : ''
								}"
								data-song-id="${song.songid}"
								${isQueued ? 'disabled' : ''}
								title="Add to Queue"
							>
								<span class="text-full hidden sm:inline">Add to Queue</span>
								<span class="text-short sm:hidden">+</span>
								<svg class="spinner animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
									<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
									<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
								</svg>
							</button>
						`;
						const addButton = songElement.querySelector('.add-to-queue-btn');
						addButton.addEventListener('click', () => addToQueue(song, songElement, addButton));

						searchResultsContainer.appendChild(songElement);
					});

					// Restore focus if applicable
					if (focusedSongIndex >= 0 && focusedSongIndex < searchResults.length) {
						const songCards = searchResultsContainer.querySelectorAll('.song-card');
						songCards[focusedSongIndex].focus();
					}
				} else if (searchInput.value.trim() && !isSearching) {
					resultsHeading.textContent = '';
					searchResultsContainer.innerHTML = '';
					noResults.classList.remove('hidden');
				} else {
					clearResults();
				}
			}

			// Clear search results
			function clearResults() {
				resultsHeading.textContent = '';
				searchResultsContainer.innerHTML = '';
				noResults.classList.add('hidden');
				focusedSongIndex = -1;
			}

			// Add a song to the queue
			async function addToQueue(song, songElement, addButton) {
				if (!sessionId) {
					showMessage('Session ID not found. Please refresh the page.', 'error');
					return;
				}

				// Disable the button
				addButton.disabled = true;
				addButton.classList.add('disabled-btn', 'loading');
				songElement.classList.add('animate-song-added');
				setTimeout(() => {
					songElement.classList.remove('animate-song-added');
				}, 1000);
				try {
					const response = await fetch('/api/songqueue', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({
							sessionId,
							songid: song.songid,
							Artist: song.Artist,
							Title: song.Title,
							filePath: song.path,
							status: 'pending',
							startTime: 0,
						}),
					});

					if (!response.ok) {
						throw new Error('Failed to add song to queue');
					}

					const data = await response.json();
					const sequenceID = data.sequenceID;
					fetchQueueCount();
					if (sequenceID) {
						showMessage(
							`"${song.Title}" by ${song.Artist} added to queue! <a href="#" class="undo-link text-white underline" data-sequence-id="${sequenceID}">Undo</a>`,
							'success'
						);
					}
				} catch (error) {
					console.error('Error adding song to queue:', error);
					showMessage('Failed to add song to queue. Please try again.', 'error');
					addButton.disabled = false;
					addButton.classList.remove('disabled-btn', 'loading');
				}
			}

			async function undoQueueAddition(sequenceID) {
				try {
					const response = await fetch(`/api/songqueue/${sequenceID}`, {
						method: 'DELETE',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ sessionId }),
					});
					if (!response.ok) {
						throw new Error('Failed to remove song from queue');
					}
					fetchQueue();
				} catch (error) {
					console.error('Error removing song from queue:', error);
					showMessage('Failed to undo queue addition. Please try again.', 'error');
				}
			}

			async function fetchQueue() {
				if (!sessionId) {
					showMessage('Session ID not found. Please refresh the page.', 'error');
					return;
				}

				try {
					const response = await fetch(`/api/songqueue/session/${sessionId}`);

					if (!response.ok) {
						throw new Error('Failed to fetch queue');
					}

					const data = await response.json();
					queueItems = data;
					displayQueue();
					updateQueueCount(queueItems.length);
					if (searchResults.length > 0) {
						displaySearchResults();
					}
				} catch (error) {
					console.error('Error fetching queue:', error);
					showMessage('Failed to fetch queue. Please check your network.', 'error');
					queueItems = [];
					displayQueue();
				}
			}

			// Just update the queue count
			async function fetchQueueCount() {
				if (!sessionId) return;

				try {
					const response = await fetch(`/api/songqueue/session/${sessionId}`);
					if (!response.ok) throw new Error('Failed to fetch queue count');

					const data = await response.json();
					updateQueueCount(data.length);
				} catch (error) {
					console.error('Error fetching queue count:', error);
				}
			}

			// Update queue count in UI
			function updateQueueCount(count) {
				queueCount.textContent = count;
			}

			// Display queue items
			function displayQueue() {
				queueResults.innerHTML = '';

				if (queueItems.length > 0) {
					emptyQueue.classList.add('hidden');

					queueItems.forEach((song, index) => {
						const queueItem = document.createElement('div');
						queueItem.className = 'border-b border-gray-700 py-4 flex justify-between items-center';

						queueItem.innerHTML = `
							<div>
								<h3 class="text-xl font-bold text-white">${escapeHtml(song.Title || '')}</h3>
								<p class="text-gray-400">${escapeHtml(song.Artist || '')} • ${song.status || 'pending'}</p>
							</div>
							<div class="flex items-center">
								<span class="bg-purple-800 text-white px-3 py-1 rounded-md">#${index + 1}</span>
							</div>
						`;

						queueResults.appendChild(queueItem);
					});
				} else {
					emptyQueue.classList.remove('hidden');
				}
			}

			function showMessage(html, type) {
				messageContainer.innerHTML = html;
				messageContainer.className = `p-3 rounded text-sm message animate-slide-in ${
					type === 'success'
						? 'bg-green-800 text-green-100'
						: type === 'info'
						? 'bg-blue-800 text-blue-100'
						: 'bg-red-800 text-red-100'
				}`;
				messageContainer.classList.remove('hidden');

				const undoLink = messageContainer.querySelector('.undo-link');
				if (undoLink) {
					undoLink.addEventListener('click', (e) => {
						e.preventDefault();
						const sequenceID = undoLink.getAttribute('data-sequence-id');
						undoQueueAddition(sequenceID);
						messageContainer.classList.add('hidden');
					});
				}

				setTimeout(() => {
					messageContainer.classList.add('hidden');
					messageContainer.classList.remove('animate-slide-in');
				}, 3000);
			}

			// Helper function to escape HTML (prevent XSS)
			function escapeHtml(unsafe) {
				if (!unsafe) return '';
				return unsafe
					.replace(/&/g, '&amp;')
					.replace(/</g, '&lt;')
					.replace(/>/g, '&gt;')
					.replace(/"/g, '&quot;')
					.replace(/'/g, '&#039;');
			}

			// Initialize the app when the DOM is fully loaded
			document.addEventListener('DOMContentLoaded', init);
		</script>
	</body>
</html>
